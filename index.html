<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=0.9">
    <meta name="author" content="Yankuan Zhang">
    <title>Avatartist</title>

    <link rel='shortcut icon' href='favicon.ico' type='image/x-icon' />
    <link rel="stylesheet" href="style.css" />

    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <!-- Latest compiled and minified jQuery -->
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

</head>

<body>
    <div id="loading"> </div>
    <div id="bodydiv" class="container">
        <div id="prelude">
            <button id="upload" class="btn btn-danger btn-lg">
                <span class="glyphicon glyphicon-upload"></span> 上传
            </button>
            <input id="upload-input" type="file" accept="image/*">
        </div>

        <div id="canvas-div" class="container">
            <canvas id="canvas"></canvas>
            <div id="palette" class="container">
                <div>
                    <button id="backgroundcolor-w" class="btn btn-secondary-outline btn-lg color-btn">白</button>
                    <button id="backgroundcolor-k" class="btn btn-black-outline btn-lg color-btn">黑</button>
                </div>
                <div>
                    <button id="backgroundcolor-r" class="btn btn-danger-outline btn-lg color-btn">红</button>
                    <button id="backgroundcolor-b" class="btn btn-primary-outline btn-lg color-btn">蓝</button>
                    <button id="backgroundcolor-g" class="btn btn-success-outline btn-lg color-btn">绿</button>
                </div>
            </div>
        </div>

        <div id="submit-div">
            <a id="saveanchor">
                <button id="download" class="btn btn-danger btn-lg">
                    <span class="glyphicon glyphicon-download"></span> 下载
                </button>
            </a>
        </div>

        <div id="ack">
            <hr>
            <br>
            <h1>微信扫码以支持该项目</h1>
            <br>
            <div>
                <img src="wechatpay.jpg" />
            </div>
            <br>
        </div>

        <script>
            $(function() {
                // hide them
                $("#submit-div").css("display", "none")
                $("#save-div").css("display", "none");
                $("#canvas-div").css("display", "none");
                $("#ack").css("display", "none");


                // set prelude position 
                $("#prelude").offset({
                    top: $(window).height() * .4
                });

                // global context
                canvas = document.getElementById("canvas") // cannot use $("#") here
                canvas.width = 800;
                canvas.height = 800;
                context = canvas.getContext('2d');
                cW = canvas.width;
                cH = canvas.height;

                var bk = new Image();
                var fr = new Image();

                bk.src = "bk750.jpg";
                bk.onload = function() {
                    bk.crossOrigin = 'anonymous';
                    context.drawImage(bk, 0, 0, cW, cH);
                    bkDataArray = context.getImageData(0, 0, cW, cH).data;
                    context.clearRect(0, 0, cW, cH);
                }

                fr.src = "fr750.jpg";
                fr.onload = function() {
                    fr.crossOrigin = 'anonymous';
                    context.drawImage(fr, 0, 0, cW, cH);
                    frDataArray = context.getImageData(0, 0, cW, cH).data;
                    context.clearRect(0, 0, cW, cH);
                }

                $("#loading").css("display", "none");
            });

            $("#upload").click(function() {
                $("#upload-input").click()
            })

            $("#upload-input").on("change", function() {
                var im = new Image();

                var oFReader = new FileReader();
                oFReader.readAsDataURL($("#upload-input").get(0).files[0]);
                filename = $("#upload-input").get(0).files[0].name;
                oFReader.onload = function(oFREvent) {
                    var userImageSrc = oFREvent.target.result;
                    im.src = userImageSrc;
                    im.onload = function() {
                        context.drawImage(im, 0, 0, cW, cH);
                        imDataArray = context.getImageData(0, 0, cW, cH).data;
                        imDataArraySource = context.getImageData(0, 0, cW, cH).data;
                    }
                }

                // show them
                $("#submit-div").css("display", "initial");
                $("#save-div").css("display", "none");
                $("#canvas-div").css("display", "initial");

                // set prelude position 
                $("#prelude").css("top", "0%")
            })

            function styleBlackButton(flag) {
                if (flag === "on") {
                    $("#backgroundcolor-k").css("background-color", "black");
                    $("#backgroundcolor-k").css("color", "white");
                } else {
                    $("#backgroundcolor-k").css("background-color", "white");
                    $("#backgroundcolor-k").css("color", "black");
                }
            }

            $(".color-btn").click(function() {

                $("#ack").css("display", "initial");

                var color = $(this).attr("id");
                console.debug(color);

                if (color == "backgroundcolor-k") {
                    styleBlackButton("on");
                } else {
                    styleBlackButton("off");
                }

                // core algorithm
                for (var i = 0; i < imDataArray.length; i += 4) {
                    if (imDataArraySource[i] < 170) { // this value is proposed by Jibin
                        imDataArray[i + 0] = frDataArray[i + 0]; // r
                        imDataArray[i + 1] = frDataArray[i + 1]; // g
                        imDataArray[i + 2] = frDataArray[i + 2]; // b
                        imDataArray[i + 3] = frDataArray[i + 3]; // a
                    } else {
                        if (color == "backgroundcolor-r") {
                            imDataArray[i + 0] = bkDataArray[i + 0]; // r
                            imDataArray[i + 1] = bkDataArray[i + 1]; // g
                            imDataArray[i + 2] = bkDataArray[i + 2]; // b
                        } else if (color == "backgroundcolor-g") {
                            imDataArray[i + 0] = bkDataArray[i + 1]; // r
                            imDataArray[i + 1] = bkDataArray[i + 0] - 50; // g
                            imDataArray[i + 2] = bkDataArray[i + 2]; // b
                        } else if (color == "backgroundcolor-b") {
                            imDataArray[i + 0] = bkDataArray[i + 2]; // r
                            imDataArray[i + 1] = bkDataArray[i + 1]; // g
                            imDataArray[i + 2] = bkDataArray[i + 0]; // b
                        } else if (color == "backgroundcolor-w") {
                            imDataArray[i + 0] = 255; // r
                            imDataArray[i + 1] = 255; // g
                            imDataArray[i + 2] = 255; // b
                        } else if (color == "backgroundcolor-k") {
                            var gray = Math.round((bkDataArray[i + 0] + bkDataArray[i + 1] + bkDataArray[i + 0]) / 3) - 130;
                            imDataArray[i + 0] = gray; // r
                            imDataArray[i + 1] = gray; // g
                            imDataArray[i + 2] = gray; // b
                        }
                        imDataArray[i + 3] = bkDataArray[i + 3]; // a
                    }
                }

                // notification
                console.debug("new image is computed.");

                context.clearRect(0, 0, cW, cH);

                // output image to canvas
                context.putImageData(new ImageData(imDataArray, cW, cH), 0, 0, 0, 0, cW, cH);

                document.getElementById("saveanchor").href = canvas.toDataURL('image/jpeg', 0.6);
                document.getElementById("saveanchor").download = color.substring(color.length - 1) + "_" + filename;

                $("#ack").css("display", "initial");
                $("#submit-div").css("display", "initial");
                $("#save-div").css("display", "initial");
            })

        </script>
    </div>
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>-->
    <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/js/bootstrap.min.js" integrity="sha384-vZ2WRJMwsjRMW/8U7i6PWi6AlO1L79snBrmgiDpgIWJ82z8eA5lenwvxbMV1PAh7" crossorigin="anonymous"></script>


</body>

</html>

<!--
canvas.toDataURL('image/jpeg', quality)
Creates a JPG image. Optionally, you can provide a quality in the range from 0 to 1, with one being the best quality and with 0 almost not recognizable but small in file size.
Once you have generated a data URI from you canvas, you are able to use it as the source of any <image> or put it into a hyper link with a download attribute to save it to disc, for example.

https://github.com/blueimp/JavaScript-Load-Image
-->
