<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="author" content="Yankuan Zhang">
    <title>Avatartist</title>
    <link rel='shortcut icon' href='favicon.ico' type='image/x-icon' />
    <link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body onload="preload()">
    <div id="main">
        <h1 id="header">Feature your avatar online!</h1>
        <div id="desc">
            <br>
        </div>
        <div id="uploaddiv">
            <div class="fileUpload btn">
                <span>Upload</span>
                <input type="file" class="button" id="uploadImage" accept="image/*" onchange="previewImage()" />
            </div>
        </div>

        <!--        <a id="downloadImage">-->
        <canvas id="canvas" width="750" height="750"></canvas>
        <!--        </a>-->
        <br>
        <div id="submitdiv">
            <div class="fileUpload btn">
                <span>Process</span>
                <input id="submit" class="button" type="submit" onclick="doit()" />
            </div>
        </div>
        <div id="savediv">
            <a id="saveanchor">
                <div class="fileUpload btn">
                    <span>Save</span>
                </div>
            </a>
        </div>
    </div>

    <div id="ack">
        <hr>
        <br>
        <span>Scan the QR-code to donate for this project on Wechat</span>
        <div>
            <img src="wechat.jpg" />
        </div>
        <br>
    </div>
    <script>
        function preload() {

            // global context
            canvas = document.getElementById('canvas');
            context = canvas.getContext('2d');
            cW = canvas.width;
            cH = canvas.height;

            var bk = new Image();
            var fr = new Image();

            bk.src = "bk750.jpg";
            bk.onload = function() {
                context.drawImage(bk, 0, 0, cW, cH);
                bkDataArray = context.getImageData(0, 0, cW, cH).data; //.slice(0);
                context.clearRect(0, 0, cW, cH);
            }

            fr.src = "fr750.jpg";
            fr.onload = function() {
                context.drawImage(fr, 0, 0, cW, cH);
                frDataArray = context.getImageData(0, 0, cW, cH).data; //.slice(0);
                context.clearRect(0, 0, cW, cH);
            }

            // notification
            console.log("two gound images are ready.");

            // disable "submit" button
            document.getElementById("submit").disabled = true;
            //            document.getElementById("downloadImage").disabled = true;

            // hide them
            document.getElementById("submitdiv").style.display = "none";
            document.getElementById("savediv").style.display = "none";
            //            document.getElementById("downloadImage").style.display = "none";
            document.getElementById("ack").style.display = "none";
            document.getElementById("canvas").style.display = "none";


        }

        function previewImage() {
            var im = new Image();

            var oFReader = new FileReader();
            oFReader.readAsDataURL(document.getElementById("uploadImage").files[0]);
            filename = document.getElementById("uploadImage").files[0].name;
            oFReader.onload = function(oFREvent) {
                    var userImageSrc = oFREvent.target.result;
                    im.src = userImageSrc;
                    im.onload = function() {
                        context.drawImage(im, 0, 0, cW, cH);
                        imDataArray = context.getImageData(0, 0, cW, cH).data; //.slice(0);
                    }
                }
                //            document.getElementById("downloadImage").removeAttribute("downloadImage");
                //            document.getElementById("downloadImage").removeAttribute("href");
                // now user can submit
            document.getElementById("submit").disabled = false;

            // show them
            document.getElementById("submitdiv").style.display = "initial";
            document.getElementById("savediv").style.display = "none";
            document.getElementById("canvas").style.display = "initial";
            //            document.getElementById("downloadImage").style.display = "initial";
            document.getElementById("header").style.marginTop = "initial";
        }

        function doit() {

            // core algorithm
            for (var i = 0; i < imDataArray.length; i++) {
                if (imDataArray[i] < 170) { // this value is proposed by Jibin
                    imDataArray[i] = frDataArray[i];
                } else {
                    imDataArray[i] = bkDataArray[i];
                }
            }

            // notification
            console.log("new image is computed.");

            context.clearRect(0, 0, cW, cH);

            // output image to canvas
            context.putImageData(new ImageData(imDataArray, cW, cH), 0, 0, 0, 0, cW, cH);

            //            document.getElementById("downloadImage").href = canvas.toDataURL('image/jpeg', 0.5);
            //            document.getElementById("downloadImage").download = "HCNY_" + filename;

            document.getElementById("saveanchor").href = canvas.toDataURL('image/jpeg', 0.6);
            document.getElementById("saveanchor").download = "HCNY_" + filename;

            // cannot resubmit
            document.getElementById("submit").disabled = true;
            //            document.getElementById("downloadImage").disabled = false;
            document.getElementById("ack").style.display = "initial";
            //            document.getElementById("downloadImage").style.display = "initial";
            document.getElementById("submitdiv").style.display = "none";
            document.getElementById("savediv").style.display = "initial";
        }

    </script>
</body>

</html>

<!--
canvas.toDataURL('image/jpeg', quality)
Creates a JPG image. Optionally, you can provide a quality in the range from 0 to 1, with one being the best quality and with 0 almost not recognizable but small in file size.
Once you have generated a data URI from you canvas, you are able to use it as the source of any <image> or put it into a hyper link with a download attribute to save it to disc, for example.

https://github.com/blueimp/JavaScript-Load-Image
-->
